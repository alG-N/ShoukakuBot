# ==============================================================
# shoukaku BOT - Core Services
# Docker Desktop folder: shoukaku-bot
# ==============================================================
# Use start.ps1 / stop.ps1 to manage the full stack
# Or: docker compose up -d (bot + DB + cache only)
# ==============================================================

name: shoukaku-bot

networks:
  shoukaku-net:
    external: true

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: shoukaku-postgres
    restart: on-failure:5
    networks:
      - shoukaku-net
    environment:
      POSTGRES_USER: ${DB_USER:-shoukaku}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-shoukaku_secret}
      POSTGRES_DB: ${DB_NAME:-shoukaku_db}
    ports:
      - "${DB_PORT:-5433}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init:/docker-entrypoint-initdb.d:ro
    command:
      - "postgres"
      - "-c" 
      - "shared_buffers=64MB"
      - "-c"
      - "effective_cache_size=128MB"
      - "-c"
      - "work_mem=4MB"
      - "-c"
      - "maintenance_work_mem=32MB"
      - "-c"
      - "wal_buffers=4MB"
      - "-c"
      - "max_connections=30"
      - "-c"
      - "logging_collector=off"
    shm_size: '64mb'
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 96M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-shoukaku} -d ${DB_NAME:-shoukaku_db}"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: shoukaku-redis
    restart: on-failure:5
    networks:
      - shoukaku-net
    ports:
      - "${REDIS_PORT:-6380}:6379"
    volumes:
      - redis_data:/data
    command: >
      redis-server
      --appendonly yes
      --maxmemory 96mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --tcp-keepalive 60
      --hz 10
      --activedefrag no
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 48M
    logging:
      driver: "json-file"
      options:
        max-size: "3m"
        max-file: "2"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 5s

  # yt-dlp HTTP API (video download microservice)
  ytdlp-api:
    build: ./docker/ytdlp-api
    container_name: shoukaku-ytdlp-api
    restart: on-failure:5
    networks:
      - shoukaku-net
    volumes:
      - video_temp:/downloads
      - ./docker/cobalt/cookies.json:/cookies.json:ro
    environment:
      MAX_CONCURRENT_DOWNLOADS: "5"
      MAX_DURATION_SECONDS: "600"
      MAX_FILE_SIZE_MB: "100"
      COOKIE_PATH: "/cookies.json"
    deploy:
      resources:
        limits:
          memory: 384M
        reservations:
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:8900/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

  # shoukaku Bot Application
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: shoukaku-bot
    restart: on-failure:5
    networks:
      - shoukaku-net
    ports:
      - "3000:3000"
    volumes:
      - video_temp:/app/dist/services/video/temp
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      ytdlp-api:
        condition: service_healthy
      # Lavalink nodes are in separate compose - bot auto-reconnects (30 retries)
    environment:
      # Bot core configuration
      BOT_TOKEN: ${BOT_TOKEN:?BOT_TOKEN is required in .env}
      CLIENT_ID: ${CLIENT_ID:?CLIENT_ID is required in .env}
      # Database configuration (PostgreSQL on shared shoukaku-net network)
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_USER: ${DB_USER:-shoukaku}
      DB_PASSWORD: ${DB_PASSWORD:-shoukaku_secret}
      DB_NAME: ${DB_NAME:-shoukaku_db}
      # Redis configuration (Redis on shared shoukaku-net network)
      REDIS_URL: redis://redis:6379
      # Owner / Logging (optional)
      OWNER_IDS: ${OWNER_IDS:-}
      GUILD_LOG_CHANNEL_ID: ${GUILD_LOG_CHANNEL_ID:-}
      REPORT_CHANNEL_ID: ${REPORT_CHANNEL_ID:-}
      SYSTEM_LOG_CHANNEL_ID: ${SYSTEM_LOG_CHANNEL_ID:-}
      SUPPORT_GUILD_ID: ${SUPPORT_GUILD_ID:-}
      # API Keys (optional)
      STEAM_API_KEY: ${STEAM_API_KEY:-}
      REDDIT_CLIENT_ID: ${REDDIT_CLIENT_ID:-}
      REDDIT_SECRET_KEY: ${REDDIT_SECRET_KEY:-}
      PIXIV_REFRESH_TOKEN: ${PIXIV_REFRESH_TOKEN:-}
      PIXIV_CLIENT_ID: ${PIXIV_CLIENT_ID:-}
      PIXIV_CLIENT_SECRET: ${PIXIV_CLIENT_SECRET:-}
      RULE34_USER_ID: ${RULE34_USER_ID:-}
      RULE34_API_KEY: ${RULE34_API_KEY:-}
      # Music (Lavalink nodes on shared network)
      LAVALINK_HOST_1: lavalink-1
      LAVALINK_HOST_2: lavalink-2
      LAVALINK_HOST_3: lavalink-3
      LAVALINK_PORT: "2333"
      LAVALINK_PORT_2: "2333"
      LAVALINK_PORT_3: "2333"
      LAVALINK_PASSWORD: ${LAVALINK_PASSWORD:-youshallnotpass}
      # Spotify (for autoplay recommendations & fallback search)
      SPOTIFY_CLIENT_ID: ${SPOTIFY_CLIENT_ID:-}
      SPOTIFY_CLIENT_SECRET: ${SPOTIFY_CLIENT_SECRET:-}
      SPOTIFY_REFRESH_TOKEN: ${SPOTIFY_REFRESH_TOKEN:-}
      # Video (Cobalt instances on shared network)
      COBALT_INSTANCES: "http://cobalt-1:9000,http://cobalt-2:9000,http://cobalt-3:9000"
      # yt-dlp API
      YTDLP_API_URL: "http://ytdlp-api:8900"
      # Sentry (optional)
      SENTRY_DSN: ${SENTRY_DSN:-}
      # Node.js configuration
      NODE_ENV: ${NODE_ENV:-production}
      NODE_OPTIONS: "--max-old-space-size=384"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 192M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:3000/health || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # YT-Cipher (Lavalink YouTube plugin dependency)
  yt-cipher:
    image: ghcr.io/kikkia/yt-cipher:master
    container_name: ejs_signature_api
    restart: on-failure:3
    networks:
      - shoukaku-net
    ports:
      - "8001:8001"
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 96M
    logging:
      driver: "json-file"
      options:
        max-size: "3m"
        max-file: "2"

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  video_temp:
    driver: local
